name: Deploy Homologação

on:
  push:
    branches:
      - homolog
    paths:
      - "bitbook-api/**"
      - "bittopics-api/**"
      - "bittrainers-api/**"
  pull_request:
    types: [closed]
    branches:
      - homolog
    paths:
      - "bitbook-api/**"
      - "bittopics-api/**"
      - "bittrainers-api/**"

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect changed APIs
        id: detect-apis
        run: |
          CHANGED_APIS=()

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="HEAD^"
            HEAD_SHA="HEAD"
          fi

          echo "Comparing changes between $BASE_SHA and $HEAD_SHA"

          if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^bitbook-api/"; then
            CHANGED_APIS+=("bitbook-api")
          fi
          if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^bittopics-api/"; then
            CHANGED_APIS+=("bittopics-api")
          fi
          if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^bittrainers-api/"; then
            CHANGED_APIS+=("bittrainers-api")
          fi

          if [ ${#CHANGED_APIS[@]} -eq 0 ]; then
            echo "No APIs changed in this commit"
            echo "changed_apis=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed APIs: ${CHANGED_APIS[*]}"
          echo "changed_apis=${CHANGED_APIS[*]}" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOMOLOG_EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOMOLOG_EC2_HOST }} >> ~/.ssh/known_hosts

          # Debug: Verificar se a chave foi salva corretamente
          echo "Checking SSH key format..."
          ssh-keygen -l -f ~/.ssh/deploy_key || echo "Invalid key format"

          # Debug: Mostrar as primeiras linhas da chave (sem expor o conteúdo completo)
          echo "First few lines of the key:"
          head -n 2 ~/.ssh/deploy_key

      - name: Deploy changed APIs
        if: steps.detect-apis.outputs.changed_apis != ''
        run: |
          IFS=' ' read -ra APIS <<< "${{ steps.detect-apis.outputs.changed_apis }}"
          for api in "${APIS[@]}"; do
            echo "Deploying $api..."

            if [ ! -d "$api" ]; then
              echo "Error: API directory $api not found"
              exit 1
            fi

            if [[ "$api" == "bitbook-api" ]]; then
              DB_NAME=${{ secrets.HOMOLOG_BANCO_BITBOOK }}
            elif [[ "$api" == "bittopics-api" ]]; then
              DB_NAME=${{ secrets.HOMOLOG_BANCO_BITTOPICS }}
            elif [[ "$api" == "bittrainers-api" ]]; then
              DB_NAME=${{ secrets.HOMOLOG_BANCO_BITTRAINERS }}
            else
              echo "Error: Invalid API detected"
              exit 1
            fi

            backup_file="backup_${api}_homolog_$(date +%Y%m%d_%H%M%S).sql"

            echo "Backup DB..."
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
              "mkdir -p /home/ec2-user/bitplus-backend/backups && \
              mysqldump -h ${{ secrets.HOMOLOG_DB_HOST }} -u ${{ secrets.HOMOLOG_DB_USER }} -p${{ secrets.HOMOLOG_DB_PASSWORD }} $DB_NAME > /home/ec2-user/bitplus-backend/backups/$backup_file"

            echo "Pull latest code..."
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
              "cd /home/ec2-user/bitplus-backend && git pull origin homolog"

            echo "Docker Compose up..."
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
              "cd /home/ec2-user/bitplus-backend/infra && docker-compose up -d --build $api"

            echo "Running migrations..."
            if ! ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
              "cd /home/ec2-user/bitplus-backend/infra && \
              docker-compose exec $api npm run migration:show && \
              docker-compose exec $api npm run migration:run"; then

              echo "Migration failed, rolling back..."

              ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
                "mysql -h ${{ secrets.HOMOLOG_DB_HOST }} -u ${{ secrets.HOMOLOG_DB_USER }} -p${{ secrets.HOMOLOG_DB_PASSWORD }} $DB_NAME < /home/ec2-user/bitplus-backend/backups/$backup_file"

              ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HOMOLOG_EC2_USER }}@${{ secrets.HOMOLOG_EC2_HOST }} \
                "cd /home/ec2-user/bitplus-backend && \
                git reset --hard HEAD^ && \
                cd /home/ec2-user/bitplus-backend/infra && \
                docker-compose up -d --build $api"

              echo "Rollback completed"
              exit 1
            fi
          done

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deployment failed for one or more APIs"
          exit 1
